## NAT介绍

这段视频将讲述网络地址转换的基础知识，以及网络地址转换器（NAT）是如何工作的。



### 强端到端

![nat/2]()


所以，如果我们回到端到端原则，就有强的端到端观点，即网络的工作是尽可能高效灵活地传输数据报，所有其他的事情都应该在网络边缘进行。

在这个模型中，我们有两个拥有IP地址的主机，互联网完成主机和设备之间的工作。节点应该做的就是转发和传输他们的数据报，通过互联网沿着某个路由发送数据报，找出最佳路由并交付数据报。所有的智能都在网络边缘，因为那是执行的地方；当你添加东西时，就开始引入依赖性和复杂性，使事情普遍变得更加艰难。

网络地址转换器（NAT）就是这样一个例子，NAT所做的就是用一个内部和一个外部接口来重写分组：

![3]()

假设NAT的内部接口为i，外部接口为x，分组可能来自17.164.15.55，那么NAT将重写它来自IP地址x，所以在分组进入其他主机时，主机将看到它来自x，主机将发送一个分组回x。

因此，NAT可能会将分组的目的地或者出发地修改为x，这具有一系列非常好的优点.

例如，今天几乎所有的无线路由器基本上都是家用无线路由器，其理念是，你将无线路由器连接到互联网连路，ISP给你一个单一的IP地址，让我们称之为X；然后在内部，它可以将许多机器全部转换为单一的公共IP地址。因此这是一个让一大堆节点共享一个IP地址的方法，该方法允许房子里10台机器使用一个单一的IP地址。

这提供了一些安全属性，因为你的IP地址被隐藏在后面，很难让对手或攻击者开始打开连接到你的机器，所以这是一种防火墙安全保护，所以NAT真的非常有吸引力和流行，带来很多优势和功能。



### NAT例子

![4]()

现在让我通过一个更具体的例子，用一些IPad来说明当你坐在网络后面时到底发生了什么，所以这两个主机A和B，他们都在NATS后面，他们的这些nats是在完全不同的网络上，其中一个IP地址128 34 228，另一个是76 18 1 17 20。这两个人的家里有不同的isp，所以首先要注意的是，nats给了他们后面的这些主机以10开头的私人ap地址。

因此，如果你试图在互联网上向10发送一个分组，它不会去任何地方，它可能会去一个它认为是一个私有本地地址的地方。事实上，你有一对一的私有本地机器，因此navs可以共享这些IP地址。 事实上，在b和a后面的机器有可能有相同的IP地址，因为IP只在他们的小域内有效。

![5]()

所以现在当a想要打开与网络中的ssh服务器的连接时会发生什么，比如说，它试图打开一个连接。当a发送消息时，这将导致tcp syn包源地址将是10.0.0.101，目的地为18.181.0.31。为了简单起见，假设源端口是5000，目标端口将是22。

现在，当这个分组通过nat时，它将转换(重写)网络地址址，这样分组就不会来自10.0.0.101，而是来自128.34.22.8。目的地端口将保持不变，但事实证明nat还必须重写源端口，因为如果nat后面的两台主机都决定使用端口5000，则会发生什么情况？它无法共享端口5000，因此我们将源端口写为8035。

然后，该分组通过internet发送到ssh服务器，该服务器看到来自128.34.22.8，端口8035的请求，它将生成tcp syn/ack，并响应该IP地址和端口。当nat看到该分组返回时，它将重新传输128.34.22.8.8035到10.0.0.101. 5000并将该分组转发给a，因此它在该内部端口IP和外部端口IP对之间建立映射。

同样，当主机b向ssh服务器发送分组时，就会把它的IP地址导入到它自己的IP地址中。所以b的IP地址就变成了它自己的地址，所以曾经的10.1.1.9，端口13013就变成端口2009。

这样，当ssh服务器发送这个tcp syn/ack回来时，它会把它发送到这个IP地址端口对，然后它可以翻译回内部IP, a地址端口对，并传递给节点b。那么这是如何工作的？nat神奇地设置了这些映射，你知道它是如何管理这些映射的，原来有各种不同的方式nat可以操作，我们将在一些未来的视频中看看，但基本模型是，nat在收到来自内部的请求之前通常不会创建映射。这里我们有网络的内部接口和外部接口，所以一般来说，当nat看到发送到外部的分组时外部接口(即互联网)上的节点从其内部接口上的节点响应这些分组，它可能会生成一个映射。

在本例中，假设a正在尝试打开一个分组到服务器的端口22，因此有一个分组来自10.0.0.101，端口为5000，目的地是18.181.0.1，端口22。

也就是说，我看到一个试图打开一个连接的分组，我需要做的是为这个特定的内部端口对分配一个外部IP端口对，比如说128.34.22.8，端口7009。所以它将创建一个映射，从这个(10.0.0.101, 5000)到(128.34.22.8, 7009)，这是针对tcp的，所以分组会遍历它，查找这个映射并翻译分组，用外部IP地址端口发送分组，然后当分组从服务器回来时，它将查找并说在外部接口上收到一个分组，我将看看我是否有任何基于协议IP地址端口的匹配映射，然后如果有，将分组翻译并重写它到内部地址和端口。

这是在高层次上发生的事情，结果是有各种变化和各种细节，我们将在以后的讲座中讨论，但这是基本的模型，然后是保持一些状态，以便它能够翻译分组。一般来说，它建立这个状态是为了响应从内部接口上的节点接收分组的请求，或者是向外部节点发送分组。

所以当你通过无线连接到家里的无线路由器时，当你在网络控制面板上查找你的IP地址时，你会看到它几乎肯定是一个本地专用地址，或者你知道的10范围内的某个地址，或者192.168。然后当你向互联网上的服务器发送分组时，就会把它们翻译成自己的公共IP地址和端口。

例如，让我们看看我的IP地址，你可以看到事实上我有一个私人IP地址10.33.6.35，这不会通过互联网传播，在斯坦福大学内有一个本地的私人地址，这个IP地址不能被使用，比如你知道谷歌服务器不能用这个IP地址给我发送分组，这意味着我在一个NAT后面。事实上如果如果我输入谷歌查找我的IP，它将告诉我，我的P地址是171.66.168.122。

因此，这里发生的事情是，我有一个私人的IP地址10.33.6.35，在NAT将其转换为171.66168.22。当我向google服务器发出连接请求时，这是他们看到的IP地址(171.66168.22)，当nat接收到这些分组时，他们会将分组发送回这个IP地址(171.66168.22)，然后将它们转换回我自己的私有本地IP地址(10.33.6.35)，转发这些分组设置的连接，所以这些分组无处不在，你应该在家里尝试一下。